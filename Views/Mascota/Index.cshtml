@{
    Layout = "_AdminLayout";
}

<h2>Mascotas</h2>

<button id="btnNuevo" class="btn btn-primary mb-2">Nueva mascota</button>

<table class="table table-striped" id="tblMascotas">
    <thead>
        <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Especie</th>
            <th>Nombre</th>
            <th>Raza</th>
            <th>Edad(Años)</th>
            <th>Peso(Kg)</th>
            <th>Sexo</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="mascotaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Mascota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="IdMascota" />

                <div class="mb-3">
                    <label>Cliente</label>
                    <select id="IdCliente" class="form-select"></select>
                </div>

                <div class="mb-3">
                    <label>Especie</label>
                    <select id="IdEspecie" class="form-select"></select>
                </div>

                <div class="mb-3">
                    <label>Nombre</label>
                    <input type="text" id="Nombre" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Raza</label>
                    <input type="text" id="Raza" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Edad(Años)</label>
                    <input type="number" id="Edad" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Peso(kg)</label>
                    <input type="number" step="0.01" id="Peso" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Sexo</label>
                    <select id="Sexo" class="form-select">
                        <option>Macho</option>
                        <option>Hembra</option>
                    </select>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" id="Estado" class="form-check-input" checked />
                    <label class="form-check-label">Activo</label>
                </div>

            </div>

            <div class="modal-footer">
                <button id="btnGuardar" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalEl = document.getElementById('mascotaModal');
            const bsModal = new bootstrap.Modal(modalEl);

            // ============================
            // CARGAR COMBOS CLIENTE Y ESPECIE
            // ============================
            async function cargarCombos() {
                const clientes = await fetch('/Cliente/Listar').then(r => r.json());
                document.getElementById('IdCliente').innerHTML =
                    clientes.map(c => `<option value="${c.idCliente}">${c.nombres} ${c.apellidoPaterno}</option>`).join('');

                const especies = await fetch('/Especie/Listar').then(r => r.json());
                document.getElementById('IdEspecie').innerHTML =
                    especies.map(e => `<option value="${e.idEspecie}">${e.nombreEspecie}</option>`).join('');
            }

            // ============================
            // LISTAR MASCOTAS
            // ============================
            async function fetchList() {
                const data = await fetch('/Mascota/Listar').then(r => r.json());
                const tbody = document.querySelector('#tblMascotas tbody');
                tbody.innerHTML = '';

                data.forEach(m => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${m.idMascota}</td>
                            <td>${m.nombreCliente}</td> 
                            <td>${m.nombreEspecie}</td> 
                            <td>${m.nombre}</td>
                            <td>${m.raza}</td>
                            <td>${m.edad ?? ''}</td>
                            <td>${m.peso ?? ''}</td>
                            <td>${m.sexo}</td>
                            <td>${m.estado ? 'Activo' : 'Inactivo'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-edit" data-id="${m.idMascota}">Editar</button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${m.idMascota}">Eliminar</button>
                            </td>
                        </tr>`;
                });

                bindButtons();
            }

            // ============================
            // BOTONES EDITAR Y ELIMINAR
            // ============================
            function bindButtons() {
                // EDITAR
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        await cargarCombos();
                        const id = e.target.dataset.id;
                        const m = await fetch(`/Mascota/Obtener?id=${id}`).then(r => r.json());

                        document.getElementById('IdMascota').value = m.idMascota;
                        document.getElementById('IdCliente').value = m.idCliente;
                        document.getElementById('IdEspecie').value = m.idEspecie;
                        document.getElementById('Nombre').value = m.nombre;
                        document.getElementById('Raza').value = m.raza;
                        document.getElementById('Edad').value = m.edad;
                        document.getElementById('Peso').value = m.peso;
                        document.getElementById('Sexo').value = m.sexo;
                        document.getElementById('Estado').checked = m.estado;

                        bsModal.show();
                    });
                });

                // ELIMINAR
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if (!confirm('¿Eliminar mascota?')) return;
                        const id = parseInt(e.target.dataset.id);
                        const res = await fetch('/Mascota/Eliminar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(id)
                        });
                        const json = await res.json();
                        if (json.success) fetchList();
                        else alert('Error al eliminar');
                    });
                });
            }

            // ============================
            // NUEVA MASCOTA
            // ============================
            document.getElementById('btnNuevo').addEventListener('click', async () => {
                await cargarCombos();

                document.getElementById('IdMascota').value = 0;
                document.getElementById('Nombre').value = '';
                document.getElementById('Raza').value = '';
                document.getElementById('Edad').value = '';
                document.getElementById('Peso').value = '';
                document.getElementById('Sexo').value = 'Macho';
                document.getElementById('Estado').checked = true;

                bsModal.show();
            });

            // ============================
            // GUARDAR MASCOTA
            // ============================
            document.getElementById('btnGuardar').addEventListener('click', async () => {
                const mascota = {
                    IdMascota: parseInt(document.getElementById('IdMascota').value || 0),
                    IdCliente: parseInt(document.getElementById('IdCliente').value),
                    IdEspecie: parseInt(document.getElementById('IdEspecie').value),
                    Nombre: document.getElementById('Nombre').value,
                    Raza: document.getElementById('Raza').value,
                    Edad: document.getElementById('Edad').value ? parseInt(document.getElementById('Edad').value) : null,
                    Peso: document.getElementById('Peso').value ? parseFloat(document.getElementById('Peso').value) : null,
                    Sexo: document.getElementById('Sexo').value,
                    Estado: document.getElementById('Estado').checked
                };

                if (!mascota.IdCliente || !mascota.IdEspecie || !mascota.Nombre) {
                    alert('Seleccione Cliente, Especie y escriba el nombre de la mascota.');
                    return;
                }

                const res = await fetch('/Mascota/Guardar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mascota)
                });

                const json = await res.json();
                if (json.success) {
                    bsModal.hide();
                    fetchList();
                } else {
                    alert('Error al guardar');
                }
            });

            // CARGA INICIAL
            fetchList();
        });
    </script>
}
